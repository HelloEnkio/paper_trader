<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tableau de Bord - Paper Trading Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        h1, h2 { color: #2c3e50; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .metric-card { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-card h3 { margin-top: 0; color: #3498db; }
        .metric-card span { font-weight: bold; font-size: 1.2em; color: #2ecc71; }
        .metric-card span.negative { color: #e74c3c; }
        .metric-card span.neutral { color: #7f8c8d; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em;}
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        #activityLogContainer { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #activityLog { white-space: pre-wrap; background-color: #ecf0f1; padding: 10px; max-height: 300px; overflow-y: auto; border: 1px solid #bdc3c7; border-radius: 4px; font-family: monospace; font-size: 0.85em;}
        .chart-container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>Tableau de Bord - Paper Trading Bot</h1>

    <div class="dashboard-grid">
        <div class="metric-card">
            <h3>Capital Actuel</h3>
            <span id="currentCapital">Chargement...</span> USDT
        </div>
        <div class="metric-card">
            <h3>Rendement Total</h3>
            <span id="totalReturn">Chargement...</span>%
        </div>
        <div class="metric-card">
            <h3>Drawdown Max</h3>
            <span id="maxDrawdown">Chargement...</span>%
        </div>
        <div class="metric-card">
            <h3>Nombre de Trades</h3>
            <span id="numTrades">Chargement...</span>
        </div>
        <div class="metric-card">
            <h3>Taux de Réussite</h3>
            <span id="winRate">Chargement...</span>%
        </div>
        <div class="metric-card">
            <h3>Profit Factor</h3>
            <span id="profitFactor">Chargement...</span>
        </div>
         <div class="metric-card">
            <h3>Sharpe Ratio</h3>
            <span id="sharpeRatio">Chargement...</span>
        </div>
    </div>

    <div class="chart-container">
        <h2>Courbe d'Équité</h2>
        <canvas id="equityCurveChart" width="400" height="150"></canvas>
    </div>

    <h2>Historique des Trades</h2>
    <table id="tradesTable">
        <thead>
            <tr>
                <th>Entrée (UTC)</th>
                <th>Prix Entrée</th>
                <th>Sortie (UTC)</th>
                <th>Prix Sortie</th>
                <th>Quantité</th>
                <th>PnL Abs (USDT)</th>
                <th>PnL %</th>
                <th>Raison</th>
                <th>Commissions</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div id="activityLogContainer">
        <h2>Log d'Activité Récent (Bot)</h2>
        <pre id="activityLog">Chargement...</pre>
    </div>

    <script>
        function formatNumber(value, decimals = 2, unit = '') {
            if (value === null || typeof value === 'undefined' || value === "NaN" || Number.isNaN(parseFloat(value))) {
                return "N/A";
            }
            const num = parseFloat(value);
            if (Number.isNaN(num)) return "N/A";
            return num.toFixed(decimals) + unit;
        }

        function getPnlClass(value) {
            const num = parseFloat(value);
            if (Number.isNaN(num) || num === 0) return 'neutral';
            return num > 0 ? 'positive' : 'negative'; // Vous devrez ajouter les styles .positive, .negative
        }


        async function fetchDataAndUpdateDashboard() {
            try {
                const response = await fetch('/dashboard_data');
                if (!response.ok) {
                    console.error("Erreur HTTP de l'API:", response.status, response.statusText);
                    document.getElementById('currentCapital').innerHTML = `<span class="negative">Erreur API</span>`;
                    return;
                }
                const data = await response.json();
                console.log("Données reçues du backend:", data);

                // Mise à jour des métriques de performance
                const perf = data.performance_summary || {}; // Fallback si performance_summary est manquant
                const currentState = data.current_state || {};

                document.getElementById('currentCapital').innerHTML = `<span class="${getPnlClass(currentState.paper_capital || INITIAL_PAPER_CAPITAL)}">${formatNumber(currentState.paper_capital || INITIAL_PAPER_CAPITAL)}</span>`;
                document.getElementById('totalReturn').innerHTML = `<span class="${getPnlClass(perf.total_return_pct)}">${formatNumber(perf.total_return_pct, 2, '%')}</span>`;
                document.getElementById('maxDrawdown').innerHTML = `<span class="negative">${formatNumber(perf.max_drawdown_pct, 2, '%')}</span>`; // Drawdown est toujours négatif ou nul
                document.getElementById('numTrades').innerHTML = `<span>${perf.num_trades !== null ? perf.num_trades : "N/A"}</span>`;
                document.getElementById('winRate').innerHTML = `<span class="${getPnlClass(perf.win_rate_pct - 50)}">${formatNumber(perf.win_rate_pct, 2, '%')}</span>`; // Classe basée sur si > 50%
                document.getElementById('profitFactor').innerHTML = `<span>${formatNumber(perf.profit_factor, 2)}</span>`;
                document.getElementById('sharpeRatio').innerHTML = `<span>${formatNumber(perf.sharpe_ratio, 2)}</span>`;


                // Mise à jour du tableau des trades
                const tradesTableBody = document.getElementById('tradesTable').getElementsByTagName('tbody')[0];
                tradesTableBody.innerHTML = ""; 
                if (data.trades_history && data.trades_history.length > 0 && !data.trades_history[0].error) {
                    data.trades_history.forEach(trade => {
                        let row = tradesTableBody.insertRow();
                        row.insertCell().textContent = trade.EntryTimeUTC ? new Date(trade.EntryTimeUTC).toLocaleString() : 'N/A';
                        row.insertCell().textContent = formatNumber(trade.EntryPrice, 2);
                        row.insertCell().textContent = trade.ExitTimeUTC ? new Date(trade.ExitTimeUTC).toLocaleString() : 'N/A';
                        row.insertCell().textContent = formatNumber(trade.ExitPrice, 2);
                        row.insertCell().textContent = formatNumber(trade.Quantity, 8);
                        row.insertCell().innerHTML = `<span class="${getPnlClass(trade.PnL_Abs)}">${formatNumber(trade.PnL_Abs, 2)}</span>`;
                        row.insertCell().innerHTML = `<span class="${getPnlClass(trade.PnL_Pct*100)}">${formatNumber(trade.PnL_Pct * 100, 2, '%')}</span>`;
                        row.insertCell().textContent = trade.ExitReason;
                    });
                } else if (data.trades_history && data.trades_history.length > 0 && data.trades_history[0].error) {
                     let row = tradesTableBody.insertRow();
                     let cell = row.insertCell(); cell.colSpan = 8; cell.textContent = data.trades_history[0].error;
                } else {
                    let row = tradesTableBody.insertRow();
                    let cell = row.insertCell(); cell.colSpan = 8; cell.textContent = "Aucun trade clôturé pour l'instant.";
                }
                
                // Mise à jour du log d'activité
                if (data.activity_log && Array.isArray(data.activity_log)) {
                    document.getElementById('activityLog').textContent = data.activity_log.join("");
                } else {
                    document.getElementById('activityLog').textContent = "Log d'activité non disponible ou format incorrect.";
                }


                // Mise à jour du graphique de la courbe d'équité
                const ctxEquity = document.getElementById('equityCurveChart').getContext('2d');
                if (window.myEquityChart) {
                    window.myEquityChart.destroy();
                }
                if (perf.equity_curve_values && perf.equity_curve_timestamps && perf.equity_curve_values.length > 0) {
                    const equityTimestamps = perf.equity_curve_timestamps.map(t => {
                        return t ? new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ' ' + new Date(t).toLocaleDateString() : 'Début';
                    });
                    window.myEquityChart = new Chart(ctxEquity, {
                        type: 'line',
                        data: {
                            labels: equityTimestamps,
                            datasets: [{
                                label: 'Équité Paper Trading (USDT)',
                                data: perf.equity_curve_values,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: { 
                            scales: { 
                                y: { beginAtZero: false, ticks: { callback: function(value) { return value.toFixed(2) + ' USDT';} } },
                                x: { ticks: { maxRotation: 70, minRotation: 45, autoSkip: true, maxTicksLimit: 20 } } 
                            },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                } else {
                    // Afficher un message si pas de données pour le graphique
                    ctxEquity.clearRect(0, 0, ctxEquity.canvas.width, ctxEquity.canvas.height);
                    ctxEquity.font = "16px Arial";
                    ctxEquity.textAlign = "center";
                    ctxEquity.fillText("Données d'équité non disponibles", ctxEquity.canvas.width/2, ctxEquity.canvas.height/2);
                }
            } catch (error) {
                console.error("Erreur lors de la récupération ou de la mise à jour du dashboard:", error);
                document.getElementById('currentCapital').innerHTML = `<span class="negative">Erreur JS</span>`;
            }
        }

        // Charger les données au démarrage et rafraîchir toutes les 30 secondes
        fetchDataAndUpdateDashboard();
        setInterval(fetchDataAndUpdateDashboard, 30000); 
    </script>
</body>
</html>
